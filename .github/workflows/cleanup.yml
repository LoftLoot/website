name: Repository Maintenance

on:
  workflow_dispatch: # Manual trigger button

permissions:
  actions: write      
  deployments: write  
  contents: read

jobs:
  # Job 1: Clean up old build logs
  prune-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 5 # Keeps the last 5 builds

  # Job 2: Clean up old deployment history
  prune-deployments:
    runs-on: ubuntu-latest
    steps:
      - name: Prune old deployments
        uses: actions/github-script@v6
        with:
          script: |
            const KEEP_COUNT = 5; // FIX: Keep the 5 most recent deployments safe
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const environment = 'github-pages'; 

            console.log(`Fetching deployments for ${environment}...`);

            // 1. Fetch deployments (up to 100)
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner,
              repo,
              environment,
              per_page: 100
            });

            console.log(`Found ${deployments.length} deployments.`);

            if (deployments.length <= KEEP_COUNT) {
              console.log(`Nothing to clean up (keeping the latest ${KEEP_COUNT}).`);
              return;
            }

            // 2. Iterate, skipping the first KEEP_COUNT (preserving recent history)
            for (let i = KEEP_COUNT; i < deployments.length; i++) {
              const deployment = deployments[i];
              console.log(`Processing deployment ID ${deployment.id} (${deployment.created_at})...`);

              try {
                // Mark inactive
                await github.rest.repos.createDeploymentStatus({
                  owner,
                  repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
              } catch (e) {
                console.log(`  - Note: Could not mark inactive.`);
              }

              // Delete
              try {
                await github.rest.repos.deleteDeployment({
                  owner,
                  repo,
                  deployment_id: deployment.id
                });
                console.log(`  - Deleted.`);
              } catch (e) {
                console.error(`  - Failed to delete: ${e.message}`);
              }
            }
            console.log("Cleanup complete!");
