name: Repository Maintenance

on:
  workflow_dispatch: # Manual trigger button

permissions:
  actions: write      # Required to delete workflow runs
  deployments: write  # Required to delete deployments
  contents: read

jobs:
  # Job 1: Clean up old build logs (Workflow Runs)
  prune-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 5 # Always keep the last 5 builds for safety

  # Job 2: Clean up old deployment history (Environments)
  prune-deployments:
    runs-on: ubuntu-latest
    steps:
      - name: Prune old deployments
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const environment = 'github-pages'; 

            console.log(`Fetching deployments for ${environment}...`);

            // 1. Fetch deployments (up to 100)
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner,
              repo,
              environment,
              per_page: 100
            });

            console.log(`Found ${deployments.length} deployments.`);

            if (deployments.length <= 1) {
              console.log("Nothing to clean up (keeping the latest one).");
              return;
            }

            // 2. Iterate, skipping index 0 (the latest/active one)
            for (let i = 1; i < deployments.length; i++) {
              const deployment = deployments[i];
              console.log(`Processing deployment ID ${deployment.id}...`);

              try {
                // Mark inactive
                await github.rest.repos.createDeploymentStatus({
                  owner,
                  repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
              } catch (e) {
                console.log(`  - Note: Could not mark inactive (likely already inactive).`);
              }

              // Delete
              try {
                await github.rest.repos.deleteDeployment({
                  owner,
                  repo,
                  deployment_id: deployment.id
                });
                console.log(`  - Deleted.`);
              } catch (e) {
                console.error(`  - Failed to delete: ${e.message}`);
              }
            }
            console.log("Deployment cleanup complete!");
